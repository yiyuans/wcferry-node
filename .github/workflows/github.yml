name: GITHUB-PUBLISH

on:
  schedule:
    - cron: '0 * * * *' # æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write # å…è®¸å†™å…¥ä»£ç åº“å†…å®¹
  packages: write # å…è®¸å†™å…¥åŒ…
  id-token: write # å…è®¸å†™å…¥ ID ä»¤ç‰Œ
jobs:
  check-and-publish:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout your repo
        uses: actions/checkout@v4

      # 2. è·å–æœ€æ–°çš„ä¸Šæ¸¸å‘å¸ƒç‰ˆæœ¬
      - name: Get latest upstream release
        id: get_release
        run: |
          LATEST_TAG=$(curl -s https://api.github.com/repos/lich0821/WeChatFerry/releases/latest | jq -r .tag_name)
          echo "latest_release=$LATEST_TAG" >> $GITHUB_ENV

      # 3. è·å–æœ¬åœ°ç‰ˆæœ¬å·
      - name: Read local version
        id: get_local_version
        run: |
          LOCAL_VERSION=$(jq -r .version packages/core/src/version.json)
          echo "local_version=$LOCAL_VERSION" >> $GITHUB_ENV

      # 4. æ¯”è¾ƒç‰ˆæœ¬
      - name: Compare versions
        id: compare
        run: |
          echo "latest_release=${{ env.latest_release }}"
          echo "local_version=${{ env.local_version }}"
          if [ "${{ env.latest_release }}" != "${{ env.local_version }}" ]; then
            echo "Versions are different, new version available."
            echo "new_version=true" >> $GITHUB_ENV
          else
            echo "Versions are the same, no new version."
            echo "new_version=false" >> $GITHUB_ENV
          fi

      # 5. å¦‚æœæ²¡æœ‰æ–°ç‰ˆæœ¬ï¼Œé€€å‡ºå¹¶è¾“å‡ºå½“å‰ç‰ˆæœ¬
      - name: Exit if no new version
        if: env.new_version == 'false'
        run: |
          echo "No new version detected. Current version is ${{ env.local_version }}. Skipping publish."

      # 6. è®¾ç½® Node.js ç¯å¢ƒ
      - name: Set up Node.js
        uses: actions/setup-node@v4
        if: env.new_version == 'true'
        with:
          node-version: '22'

      # 7. å®‰è£… pnpm
      - name: Install pnpm globally
        if: env.new_version == 'true'
        run: |
          npm install -g pnpm@8
          pnpm --version  # ç¡®è®¤ pnpm å®‰è£…æˆåŠŸ

      # 8. å®‰è£…ä¾èµ–
      - name: Install dependencies
        if: env.new_version == 'true'
        run: pnpm install

      # 9. è®¾ç½® .npmrc é…ç½®ä»¥ä¾¿å‘å¸ƒ
      - name: Setup .npmrc for publish
        if: env.new_version == 'true'
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" >  ~/.npmrc

      # 10. æ›´æ–° version.json
      - name: Update version.json
        if: env.new_version == 'true'
        run: |
          jq --arg ver "${{ env.latest_release }}" '.version = $ver' packages/core/src/version.json > tmp.json && mv tmp.json packages/core/src/version.json

      # 11. éªŒè¯ NPM token æ˜¯å¦æœ‰æ•ˆ
      - name: Verify NPM token
        if: env.new_version == 'true'
        run: |
          echo "Verifying NPM token..."
          npm whoami  # éªŒè¯ token æ˜¯å¦æœ‰æ•ˆ

      # 14. å‘å¸ƒ GitHub package
      - name: Publish GitHub package
        if: env.new_version == 'true'
        run: |
          #æ¸…ç©ºç¼“å­˜
          rm -f ~/.npmrc
          # å¤åˆ¶åŸå§‹åŒ…åä¸ºä¸´æ—¶ç›®å½•ç”¨äºä¿®æ”¹ä½œç”¨åŸŸ
          cp packages/core/package.json packages/core/package.json.bak
          # ä¿®æ”¹ä½œç”¨åŸŸä¸º @dr-forget
          jq '.name = "@dr-forget/wechatcore"' packages/core/package.json > tmp && mv tmp packages/core/package.json
          # åˆ›å»º .npmrc ç”¨äº GitHub Packages å‘å¸ƒ
          echo "@dr-forget:registry=https://npm.pkg.github.com/" > ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> ~/.npmrc 
          cd packages/core
          pnpm publish --access restricted --registry=https://npm.pkg.github.com/ --no-git-checks
          echo "GitHub package published successfully."
          npm whoami # éªŒè¯ token æ˜¯å¦æœ‰æ•ˆ

        # 15. æäº¤å¹¶æ¨é€æ›´æ–°
      - name: Commit and push changes
        if: env.new_version == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "chore: update version to ${{ env.latest_release }}"  # æäº¤æ›´æ–°
          git push

        # 16.è·å–package.json ç‰ˆæœ¬å·
      - name: Read package version
        id: package_version
        run: |
          PACKAGE_VERSION=$(jq -r .version packages/core/package.json)
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_ENV

      # 17. ä¸ºæäº¤æ‰“æ ‡ç­¾
      - name: Tag the commit with release version
        if: env.new_version == 'true'
        run: |
          git tag ${{ env.package_version }}  # ä¸ºæäº¤æ·»åŠ  release ç‰ˆæœ¬æ ‡ç­¾
          git push origin ${{ env.package_version }}  # æ¨é€æ ‡ç­¾åˆ°è¿œç¨‹

      # 18. å‘å¸ƒ Release
      - name: Publish Release
        if: env.new_version == 'true'
        id: publish_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.package_version }}
          name: Release v${{ env.package_version }}
          body: |
            - ğŸ”„ Actionè‡ªåŠ¨å‘å¸ƒç‰ˆæœ¬ v${{ env.package_version }}
            - ğŸ“¦ å‘å¸ƒäº† @dr-forget/wechatcore åˆ° GitHub Packages
            - WCF ç‰ˆæœ¬å·: ${{ env.latest_release }}
          files: |
            packages/core/dist/*.tgz
            packages/cli/dist/*.tgz
